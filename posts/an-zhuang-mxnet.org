#+BEGIN_COMMENT
.. title: 安装 mxnet
.. slug: an-zhuang-mxnet
.. date: 2016-11-21 14:22:53 UTC+08:00
.. tags: 
.. category: 
.. link: 
.. description: 
.. type: text
#+END_COMMENT

使用 gcc 4.9 会编译不通过

#+BEGIN_EXAMPLE
/tmp/ccl4BojP.o：在函数‘main’中：
im2rec.cc:(.text.startup+0x2b24)：对‘cv::imencode(std::string const&, cv::_InputArray const&, std::vector<unsigned char, std::allocator<unsigned char> >&, std::vector<int, std::allocator<int> > const&)’未定义的引用
collect2: error: ld returned 1 exit status
Makefile:233: recipe for target 'bin/im2rec' failed
make: *** [bin/im2rec] Error 1 
#+END_EXAMPLE


把 gcc 和 g++ 设成 5

#+BEGIN_SRC bash
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 20
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 10
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 20
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 10
#+END_SRC

编译支持GPU的MXnet
MXnet需要打开一个编译和链接选项来支持CUDA。在前一步git clone得到的mxnet/目录里找到mxnet/make/子目录，把该目录下的config.mk复制到mxnet/目录，用文本编辑器打开，找到并修改以下几行：

USE_CUDA = 1
USE_CUDA_PATH = /usr/local/cuda
其中第二行是CUDA的安装目录。如果选择默认安装方式，它会在/usr/local/cuda或者是类似/usr/local/cuda-7.5这样的原始安装目录，如果是自定义目录的安装，请自行修改本条。

如果用户选择安装atlas或者openblas等其他BLAS的实现，需要额外的修改。如果ubuntu的atlas实现（sudo apt-get install libatlas-base-dev或者sudo apt-get install libopenblas-dev），需要修改为：

USE_BLAS = atlas 或者 openblas
修改之后，在mxnet/目录下编译（-j4是可选参数表示用4线程编译）：

make -j4
注意：如果没有CUDA支持的显卡（比如Intel的Iris显卡或者AMD的R系列显卡）或者没有显卡，安装和编译GPU版本的mxnet会出错。解决方法是，把USE_CUDA = 1改回USE_CUDA = 0，并确保USE_OPENMP = 1，mxnet会自动编译CPU版本并使用OpenMP进行多核CPU计算。根据问题的不同，GPU版本对比CPU版一般会有20-30倍左右的加速。

